name: Deploy to VPS
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Kodni yuklash
        uses: actions/checkout@v4
      - name: SSH kalitni sozlash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
        shell: bash
      - name: Serverga deploy qilish
        env:
          HOST: ${{ secrets.HOST }}
          USER: ${{ secrets.USERNAME }}
          APP_DIR: /simsetka
          PORT: ${{ secrets.PORT }}
          PG_HOST: ${{ secrets.PG_HOST }}
          PG_PORT: ${{ secrets.PG_PORT }}
          PG_USER: ${{ secrets.PG_USER }}
          PG_PASSWORD: ${{ secrets.PG_PASSWORD }}
          PG_DB: ${{ secrets.PG_DB }}
          ADMIN: ${{ secrets.ADMIN }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          GROUP_ID: ${{ secrets.GROUP_ID }}
        run: |
          ssh-keyscan -H $HOST >> ~/.ssh/known_hosts
          ssh $USER@$HOST "
            if [ ! -d $APP_DIR ]; then
              mkdir -p $APP_DIR
              git clone https://github.com/Abdulloh0104/simsetka.git $APP_DIR
              cd $APP_DIR
              echo 'PORT=${PORT}' > .env
            else 
              cd $APP_DIR
              git pull origin main
            fi
            cat <<EOT > .env
              PORT=${PORT}
              PG_HOST=${PG_HOST}
              PG_PORT=${PG_PORT}
              PG_USER=${PG_USER}
              PG_PASSWORD=${PG_PASSWORD}
              PG_DB=${PG_DB}
              ADMIN=${ADMIN}
              BOT_TOKEN=${BOT_TOKEN}
              GROUP_ID=${GROUP_ID}
            EOT
            npm install
            npm run build
            pm2 restart simsetka_app || pm2 start dist/main.js --name simsetka_app
          "
        shell: bash
